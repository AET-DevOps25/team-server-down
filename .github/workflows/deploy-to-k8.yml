name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Build and Push Docker images"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set variables
        run: |
          if [[ "${GITHUB_REF##*/}" == "main" ]]; then
            echo "NAMESPACE=tsd-prod" >> $GITHUB_ENV
            echo "VALUES_FILE=./infrastructure/whiteboard-app/production.values.yaml" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF##*/}" == "develop" ]]; then
            echo "NAMESPACE=tsd-staging" >> $GITHUB_ENV
            echo "VALUES_FILE=./infrastructure/whiteboard-app/staging.values.yaml" >> $GITHUB_ENV
          fi

      - name: Set up Kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG }}" > kubeconfig
          echo "KUBECONFIG=$(pwd)/kubeconfig" >> $GITHUB_ENV

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Deploy App with Helm
        run: |
          helm upgrade whiteboard ./infrastructure/whiteboard-app/ \
            -f ${{ env.VALUES_FILE }} \
            -n ${{ env.NAMESPACE }} \
            --install \
            --atomic \
            --kubeconfig ${{ env.KUBECONFIG }}